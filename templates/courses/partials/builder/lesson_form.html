{% comment %}
Lesson form partial for the course builder.
Used for both adding new lessons and editing existing ones.
Context: lesson_form (for new), lesson (for edit), course, module, is_new
{% endcomment %}

<form {% if is_new %}
        hx-post="{% url 'courses:builder_add_lesson' course.id module.id %}"
        hx-target="closest [data-lesson-list]"
        hx-swap="beforeend"
        @htmx:after-request="if(event.detail.successful) { showAddLesson = false; }"
      {% else %}
        hx-post="{% url 'courses:builder_edit_lesson' course.id module.id lesson.id %}"
        hx-target="closest [data-lesson-id]"
        hx-swap="outerHTML"
      {% endif %}
      x-data="{ lessonType: '{% if is_new %}video{% else %}{{ lesson.lesson_type }}{% endif %}' }"
      enctype="multipart/form-data">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Title -->
        <div class="form-control">
            <label class="label py-1">
                <span class="label-text text-xs">Titulo <span class="text-error">*</span></span>
            </label>
            <input type="text" name="title"
                   value="{% if not is_new %}{{ lesson.title }}{% endif %}"
                   class="input input-bordered input-sm w-full"
                   placeholder="Nombre de la leccion" required>
        </div>

        <!-- Type -->
        <div class="form-control">
            <label class="label py-1">
                <span class="label-text text-xs">Tipo <span class="text-error">*</span></span>
            </label>
            <select name="lesson_type" class="select select-bordered select-sm w-full"
                    x-model="lessonType">
                <option value="video">Video</option>
                <option value="pdf">PDF</option>
                <option value="text">Texto</option>
                <option value="quiz">Quiz</option>
                <option value="scorm">SCORM</option>
                <option value="interactive">Interactivo</option>
                <option value="audio">Audio</option>
                <option value="presential">Presencial</option>
            </select>
        </div>

        <!-- Duration -->
        <div class="form-control">
            <label class="label py-1">
                <span class="label-text text-xs">Duracion (minutos)</span>
            </label>
            <input type="number" name="duration"
                   value="{% if not is_new %}{{ lesson.duration }}{% else %}0{% endif %}"
                   class="input input-bordered input-sm w-full"
                   min="0" placeholder="Minutos">
        </div>

        <!-- Is Mandatory -->
        <div class="form-control">
            <label class="label py-1 cursor-pointer justify-start gap-2">
                <input type="checkbox" name="is_mandatory"
                       {% if is_new or lesson.is_mandatory %}checked{% endif %}
                       class="checkbox checkbox-primary checkbox-sm">
                <span class="label-text text-xs">Obligatorio</span>
            </label>
        </div>
    </div>

    <!-- Description (always visible) -->
    <div class="form-control mt-2">
        <label class="label py-1">
            <span class="label-text text-xs">Descripcion</span>
        </label>
        <textarea name="description" class="textarea textarea-bordered textarea-sm w-full" rows="2"
                  placeholder="Descripcion de la leccion (opcional)">{% if not is_new %}{{ lesson.description }}{% endif %}</textarea>
    </div>

    <!-- Conditional fields based on lesson type -->

    <!-- Video URL (for video type) -->
    <div class="form-control mt-2" x-show="lessonType === 'video'" x-cloak>
        <label class="label py-1">
            <span class="label-text text-xs">URL del Video</span>
        </label>
        <input type="url" name="video_url"
               value="{% if not is_new %}{{ lesson.video_url }}{% endif %}"
               class="input input-bordered input-sm w-full"
               placeholder="https://youtube.com/...">
    </div>

    <!-- Content File (for pdf, scorm, audio) -->
    <div class="form-control mt-2" x-show="['pdf', 'scorm', 'audio'].includes(lessonType)" x-cloak>
        <label class="label py-1">
            <span class="label-text text-xs">Archivo</span>
        </label>
        <input type="file" name="content_file"
               class="file-input file-input-bordered file-input-sm w-full">
        {% if not is_new and lesson.content_file %}
        <span class="text-xs text-gray-400 mt-1">Archivo actual: {{ lesson.content_file.name }}</span>
        {% endif %}
    </div>

    <!-- Content Text (for text type) -->
    <div class="form-control mt-2" x-show="lessonType === 'text'" x-cloak>
        <label class="label py-1">
            <span class="label-text text-xs">Contenido</span>
        </label>
        <textarea name="content" class="textarea textarea-bordered textarea-sm w-full" rows="4"
                  placeholder="Contenido de texto o HTML">{% if not is_new %}{{ lesson.content }}{% endif %}</textarea>
    </div>

    <!-- Actions -->
    <div class="flex gap-2 justify-end mt-3">
        {% if is_new %}
        <button type="button" class="btn btn-ghost btn-xs" @click="showAddLesson = false">Cancelar</button>
        {% else %}
        <button type="button" class="btn btn-ghost btn-xs" @click="editingLesson = false">Cancelar</button>
        {% endif %}
        <button type="submit" class="btn btn-primary btn-xs">
            {% if is_new %}Agregar{% else %}Guardar{% endif %}
        </button>
    </div>
</form>
