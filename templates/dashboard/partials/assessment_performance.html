<div id="assessment-perf-render" style="width:100%;height:100%;min-height:320px;"></div>
<script>
(function() {
    function init() {
        var el = document.getElementById('assessment-perf-render');
        if (!el || typeof echarts === 'undefined') return;
        var chart = echarts.init(el);

        var names = [{% for a in assessments %}'{{ a.title|truncatechars:20 }}'{% if not forloop.last %},{% endif %}{% endfor %}];
        var passRates = [{% for a in assessments %}{% if a.total_attempts > 0 %}{{ a.passed|floatformat:0 }}{% else %}0{% endif %}{% if not forloop.last %},{% endif %}{% endfor %}];
        var failRates = [{% for a in assessments %}{% if a.total_attempts > 0 %}{{ a.total_attempts }}{% else %}0{% endif %}{% if not forloop.last %},{% endif %}{% endfor %}];
        var avgScores = [{% for a in assessments %}{% if a.avg_score %}{{ a.avg_score|floatformat:1 }}{% else %}0{% endif %}{% if not forloop.last %},{% endif %}{% endfor %}];

        if (names.length === 0) {
            names = ['Sin evaluaciones'];
            passRates = [0];
            failRates = [0];
            avgScores = [0];
        }

        chart.setOption({
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function(params) {
                    var result = params[0].name + '<br/>';
                    params.forEach(function(p) {
                        result += p.marker + ' ' + p.seriesName + ': ' + p.value;
                        if (p.seriesName === 'Promedio') result += ' pts';
                        result += '<br/>';
                    });
                    return result;
                }
            },
            legend: { bottom: 0, textStyle: { fontSize: 11 } },
            grid: { left: '3%', right: '8%', bottom: '12%', top: '3%', containLabel: true },
            xAxis: { type: 'category', data: names, axisLabel: { rotate: 45, fontSize: 9 } },
            yAxis: [
                { type: 'value', name: 'Cantidad', minInterval: 1, position: 'left' },
                { type: 'value', name: 'Puntaje', min: 0, max: 100, position: 'right' }
            ],
            series: [
                {
                    name: 'Aprobados',
                    type: 'bar',
                    data: passRates,
                    itemStyle: { color: '#22c55e', borderRadius: [4, 4, 0, 0] }
                },
                {
                    name: 'Total Intentos',
                    type: 'bar',
                    data: failRates,
                    itemStyle: { color: '#94a3b8', borderRadius: [4, 4, 0, 0] }
                },
                {
                    name: 'Promedio',
                    type: 'line',
                    yAxisIndex: 1,
                    data: avgScores,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: { color: '#f59e0b', width: 2 },
                    itemStyle: { color: '#f59e0b' }
                }
            ]
        });
        window.addEventListener('resize', function() { chart.resize(); });
    }
    if (typeof echarts !== 'undefined') { init(); }
    else { document.addEventListener('echarts:ready', init); }
})();
</script>
