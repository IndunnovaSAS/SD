{% extends "base/dashboard.html" %}
{% load sanitize_tags %}

{% block page_title %}Conducir Charla{% endblock %}

{% block dashboard_content %}
<div class="max-w-4xl mx-auto space-y-6" x-data="talkConductor()">
    <!-- Header -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold">{{ talk.title }}</h2>
                    <p class="text-gray-500">{{ talk.project_name }} • {{ talk.location }}</p>
                </div>
                <div class="text-right">
                    <div class="badge badge-warning badge-lg animate-pulse">En Progreso</div>
                    <p class="text-sm text-gray-500 mt-1" x-text="elapsedTime"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs tabs-boxed bg-base-100 p-2">
        <button class="tab" :class="{ 'tab-active': activeTab === 'content' }" @click="activeTab = 'content'">
            Contenido
        </button>
        <button class="tab" :class="{ 'tab-active': activeTab === 'attendees' }" @click="activeTab = 'attendees'">
            Asistentes
            <span class="badge badge-sm ml-1">{{ talk.attendees.count }}</span>
        </button>
        <button class="tab" :class="{ 'tab-active': activeTab === 'questions' }" @click="activeTab = 'questions'">
            Preguntas
        </button>
    </div>

    <!-- Content Tab -->
    <div x-show="activeTab === 'content'" class="card bg-base-100 shadow">
        <div class="card-body prose dark:prose-invert max-w-none">
            {% if talk.template %}
            <h3>{{ talk.template.name }}</h3>
            {{ talk.template.content|sanitize_html }}
            {% else %}
            <p>{{ talk.content|default:"Sin contenido definido" }}</p>
            {% endif %}

            {% if talk.template.attachments.exists %}
            <h4>Material de Apoyo</h4>
            <div class="flex flex-wrap gap-2 not-prose">
                {% for attachment in talk.template.attachments.all %}
                <a href="{{ attachment.file.url }}"
                   target="_blank"
                   class="btn btn-ghost btn-sm gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                    {{ attachment.filename }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Attendees Tab -->
    <div x-show="activeTab === 'attendees'" class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">Lista de Asistentes</h3>
                <button class="btn btn-primary btn-sm"
                        onclick="document.getElementById('add-attendee-modal').showModal()">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Agregar
                </button>
            </div>

            <div id="attendees-list"
                 hx-get="{% url 'preop_talks:attendees' talk.id %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="flex justify-center py-8">
                    <span class="loading loading-spinner loading-md"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Tab -->
    <div x-show="activeTab === 'questions'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="font-bold mb-4">Preguntas de Verificación</h3>

            <!-- What can go wrong today? -->
            <div class="form-control mb-6">
                <label class="label">
                    <span class="label-text font-medium">¿Qué puede salir mal hoy?</span>
                </label>
                <textarea class="textarea textarea-bordered"
                          name="risks_identified"
                          rows="3"
                          placeholder="Identifica los riesgos del día..."
                          hx-post="{% url 'preop_talks:update-notes' talk.id %}"
                          hx-trigger="blur"
                          hx-swap="none">{{ talk.risks_identified }}</textarea>
            </div>

            {% if talk.template and talk.template.questions %}
            <div class="space-y-4">
                {% for question in talk.template.questions %}
                <div class="p-4 bg-base-200 rounded-lg">
                    <p class="font-medium mb-3">{{ question.text }}</p>
                    <div class="flex flex-wrap gap-2">
                        {% for option in question.options %}
                        <label class="cursor-pointer flex items-center gap-2">
                            <input type="radio"
                                   name="question_{{ forloop.parentloop.counter }}"
                                   value="{{ option }}"
                                   class="radio radio-primary radio-sm">
                            <span>{{ option }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Additional notes -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text font-medium">Notas adicionales</span>
                </label>
                <textarea class="textarea textarea-bordered"
                          name="notes"
                          rows="3"
                          placeholder="Observaciones, compromisos, etc..."
                          hx-post="{% url 'preop_talks:update-notes' talk.id %}"
                          hx-trigger="blur"
                          hx-swap="none">{{ talk.notes }}</textarea>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center">
        <a href="{% url 'preop_talks:list' %}" class="btn btn-ghost">
            Guardar y salir
        </a>
        <button class="btn btn-success"
                hx-post="{% url 'preop_talks:complete' talk.id %}"
                hx-confirm="¿Finalizar la charla? Asegúrate de que todos hayan firmado.">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Finalizar Charla
        </button>
    </div>
</div>

<!-- Add Attendee Modal -->
<dialog id="add-attendee-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Agregar Asistente</h3>
        <form hx-post="{% url 'preop_talks:add-attendee' talk.id %}"
              hx-target="#attendees-list"
              hx-swap="innerHTML"
              hx-on::after-request="document.getElementById('add-attendee-modal').close()">
            {% csrf_token %}
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Buscar usuario</span>
                    </label>
                    <input type="text"
                           name="search"
                           class="input input-bordered"
                           placeholder="Nombre o documento..."
                           hx-get="{% url 'preop_talks:search-users' %}"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#user-results">
                </div>
                <div id="user-results" class="mt-2 max-h-48 overflow-y-auto"></div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('add-attendee-modal').close()">Cerrar</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
function talkConductor() {
    return {
        activeTab: 'content',
        startTime: new Date('{{ talk.started_at|date:"c" }}'),
        elapsedTime: '',
        init() {
            this.updateElapsedTime();
            setInterval(() => this.updateElapsedTime(), 1000);
        },
        updateElapsedTime() {
            const now = new Date();
            const diff = Math.floor((now - this.startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            this.elapsedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
}
</script>
{% endblock %}
