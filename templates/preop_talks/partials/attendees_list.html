<div class="overflow-x-auto">
    <table class="table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Documento</th>
                <th>Cargo</th>
                <th>Firma</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for attendee in attendees %}
            <tr id="attendee-{{ attendee.id }}">
                <td>
                    <div class="flex items-center gap-2">
                        <div class="avatar placeholder">
                            <div class="bg-neutral text-neutral-content rounded-full w-8">
                                <span class="text-xs">{{ attendee.user.first_name.0 }}{{ attendee.user.last_name.0 }}</span>
                            </div>
                        </div>
                        <div>
                            <div class="font-medium">{{ attendee.user.get_full_name }}</div>
                        </div>
                    </div>
                </td>
                <td>{{ attendee.user.document_number }}</td>
                <td>{{ attendee.user.job_position }}</td>
                <td>
                    {% if attendee.signed_at %}
                    <div class="flex items-center gap-1 text-success">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm">{{ attendee.signed_at|time:"H:i" }}</span>
                    </div>
                    {% else %}
                    <button class="btn btn-primary btn-sm"
                            onclick="openSignatureModal({{ attendee.id }}, '{{ attendee.user.get_full_name }}')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                        Firmar
                    </button>
                    {% endif %}
                </td>
                <td>
                    {% if not attendee.signed_at %}
                    <button class="btn btn-ghost btn-sm text-error"
                            hx-delete="{% url 'preop_talks:remove-attendee' attendee.id %}"
                            hx-target="#attendee-{{ attendee.id }}"
                            hx-swap="outerHTML"
                            hx-confirm="Â¿Eliminar a {{ attendee.user.get_full_name }} de la lista?">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center py-8 text-gray-500">
                    No hay asistentes registrados
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Signature summary -->
{% if attendees %}
<div class="flex justify-between items-center mt-4 p-4 bg-base-200 rounded-lg">
    <div>
        <span class="font-medium">{{ signed_count }}</span> de <span class="font-medium">{{ attendees|length }}</span> han firmado
    </div>
    <div class="radial-progress text-primary" style="--value:{{ signature_percentage }}; --size:3rem;">
        <span class="text-xs">{{ signature_percentage|floatformat:0 }}%</span>
    </div>
</div>
{% endif %}

<!-- Signature Modal -->
<dialog id="signature-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Firma de <span id="signer-name"></span></h3>
        <form id="signature-form" hx-swap="innerHTML" hx-target="#attendees-list">
            {% csrf_token %}
            <input type="hidden" name="attendee_id" id="attendee-id">
            <div class="py-4">
                <p class="text-sm text-gray-500 mb-4">
                    Dibuja tu firma en el recuadro de abajo
                </p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 bg-white">
                    <canvas id="signature-canvas" width="400" height="200" class="w-full cursor-crosshair"></canvas>
                </div>
                <div class="flex justify-end mt-2">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="clearSignature()">
                        Limpiar
                    </button>
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('signature-modal').close()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar Firma</button>
            </div>
        </form>
    </div>
</dialog>

<script>
let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0;

function openSignatureModal(attendeeId, name) {
    document.getElementById('attendee-id').value = attendeeId;
    document.getElementById('signer-name').textContent = name;
    document.getElementById('signature-form').setAttribute('hx-post', `/preop-talks/attendees/${attendeeId}/sign/`);
    htmx.process(document.getElementById('signature-form'));
    document.getElementById('signature-modal').showModal();
    initCanvas();
}

function initCanvas() {
    canvas = document.getElementById('signature-canvas');
    ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch support
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    [lastX, lastY] = [e.offsetX, e.offsetY];
}

function draw(e) {
    if (!isDrawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    [lastX, lastY] = [e.offsetX, e.offsetY];
}

function stopDrawing() {
    isDrawing = false;
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    isDrawing = true;
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
}

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

document.getElementById('signature-form').addEventListener('submit', function(e) {
    const signatureData = canvas.toDataURL('image/png');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'signature';
    input.value = signatureData;
    this.appendChild(input);
});
</script>
