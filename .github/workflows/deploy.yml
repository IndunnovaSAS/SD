# =============================================================================
# SD LMS - Deploy Pipeline
# =============================================================================

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_ID: appsindunnova
  REGION: us-central1
  SERVICE_NAME: sd-lms
  IMAGE: us-central1-docker.pkg.dev/appsindunnova/sd-lms/sd-lms
  CLOUDSQL: appsindunnova:us-central1:postgres-consolidated

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Build and Push
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          docker build -t ${{ env.IMAGE }}:${{ github.sha }} -t ${{ env.IMAGE }}:latest --target production .
          docker push ${{ env.IMAGE }}:${{ github.sha }}
          docker push ${{ env.IMAGE }}:latest

      - name: Deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory 1Gi --cpu 1 --min-instances 0 --max-instances 5 \
            --add-cloudsql-instances ${{ env.CLOUDSQL }} \
            --set-env-vars "DJANGO_SETTINGS_MODULE=config.settings.cloudrun,DB_NAME=sd_lms,DB_USER=postgres,DB_HOST=/cloudsql/${{ env.CLOUDSQL }},GS_BUCKET_NAME=sd-lms-media,ALLOWED_HOSTS=*" \
            --set-secrets "SECRET_KEY=sd-lms-secret-key:latest,DB_PASSWORD=sd-lms-db-password:latest"

      - name: Run Migrations
        run: |
          gcloud run jobs deploy sd-lms-migrate \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --set-cloudsql-instances ${{ env.CLOUDSQL }} \
            --set-env-vars "DJANGO_SETTINGS_MODULE=config.settings.cloudrun,DB_NAME=sd_lms,DB_USER=postgres,DB_HOST=/cloudsql/${{ env.CLOUDSQL }}" \
            --set-secrets "SECRET_KEY=sd-lms-secret-key:latest,DB_PASSWORD=sd-lms-db-password:latest" \
            --command "python" --args "manage.py,migrate,--noinput" \
            --max-retries 0 --task-timeout 300 --quiet
          gcloud run jobs execute sd-lms-migrate --region ${{ env.REGION }} --wait
